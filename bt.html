<!DOCTYPE html>
<html>
<head>
<script>

// 蓝牙设备提供的服务的 UUIDs
//加速度传感器服务
var ACCELEROMETER_SERVICE = "e95d0753-251d-470a-a062-fa1922dfa9a8";
//LED服务
var LED_SERVICE = "e95dd91d-251d-470a-a062-fa1922dfa9a8";
//设备信息服务
var DEVICE_INFORMATION_SERVICE = "0000180a-0000-1000-8000-00805f9b34fb";
//UART服务
var UART_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
//温度传感器服务
var TEMPERATURE_SERVICE = "e95d6100-251d-470a-a062-fa1922dfa9a8";


//连接设备或断开连接
function DiscoveOrDisConnect() {
    if (Connected) {
        Connected_Device.gatt.disconnect();
        console.log("===>用户断开了连接<===")
        UpdateUI();
    }
    else {
        DiscoverDevice();
        UpdateUI();
    }
}

//发现蓝牙设备
function DiscoverDevice() {
    //过滤出我们需要的蓝牙设备
    //过滤器
    var options = {
            acceptAllDevices: true,
            optionalServices: [DEVICE_INFORMATION_SERVICE, ACCELEROMETER_SERVICE, LED_SERVICE, UART_SERVICE, TEMPERATURE_SERVICE]
    };

    navigator.bluetooth.requestDevice(options)
        .then(device => {
            console.log('> 设备名称: ' + device.name);
            console.log('> 设备Id: ' + device.id);
            console.log('> 是否已连接到其它设备: ' + device.gatt.connected);
            //连接到该设备
            Connected_Device = device;
            ConnectDevice();
        })
        .catch(error => {
            console.log("=> Exception: " + error);
        });
}

//连接到蓝牙设备
function ConnectDevice() {
    Connected_Device.gatt.connect().then(
        function (server) {
            console.log("> 连接到GATT服务器：" + server.device.id);
            console.log("> 连接成功=" + server.connected);
            //更新UI的信息
            Connected = true;
//            UpdateUI();
            //将Server赋给全局变量（已连接的GATT服务器
            Connected_Server = server;

            //监听连接断开事件
            Connected_Device.addEventListener('gattserverdisconnected', function () {
                Connected = false;
//                UpdateUI();
            });
            //发现GATT服务器的服务
            DiscoverService();
        },
        function (error) {
            console.log("=> Exception:无法连接 - " + error);
            Connected = false;
//            UpdateUI();
        });
}

//发现蓝牙设备的服务和特性
function DiscoverService() {
    console.log("> 正在搜索可用的服务......\n> 服务器：" + Connected_Server);

    //已发现的服务
    let ServicesDiscovered = 0;

    Connected_Server.getPrimaryServices()
        .then(Services => {

            //服务总数
            let ServiceSum = Services.length;
            console.log("> 发现服务数量：" + ServiceSum);

            Services.forEach(service => {

                console.log("> 获取到服务的UUID：" + service.uuid);

                service.getCharacteristics().then(Characteristics => {
                    console.log("> 服务: " + service.uuid);
                    ServicesDiscovered++;

                    //已发现的特性
                    let CharacteristicsDiscovered = 0;
                    //所有的特性
                    let CharacteristicsSum = Characteristics.length;

                    Characteristics.forEach(Characteristic => {

                        CharacteristicsDiscovered++; console.log('>> 特征值(UUID): ' + Characteristic.uuid);

                        if (ServicesDiscovered == ServiceSum && CharacteristicsDiscovered == CharacteristicsSum) {
                            console.log("===>服务搜索完成<===");
                            //更新UI的信息
//                            UpdateUI();
                            //读取设备型号
//                            ReadModelStr();
                            //实时更新加速度计的数据
//                            setTimeout(ShwoAcceleration,300);
                            //实时更新温度计的数据
//                            setTimeout(ShowTemperaturer,600);
                            
                        }
                    });

                });
            });
        });
}


</script>
</head>

<body>

<h2>bluetooth connect</h2>

<p id="demo">test3</p>


<button type="button" onclick="DiscoverDevice()">scan</button>

</body>
</html>
